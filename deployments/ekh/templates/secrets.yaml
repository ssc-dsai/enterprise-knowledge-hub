{{/*
  Auto-generated credentials secret.
  Uses `lookup` to read the existing secret on upgrades so passwords are never
  regenerated once set. On first install, random 32-char alphanumeric passwords
  are generated for both Postgres and RabbitMQ.

  The same secret is referenced by:
    - The EKH app deployment (secretKeyRef)
    - The pgvector sub-chart (auth.existingSecret) when enabled
    - The rabbitmq sub-chart (auth.existingSecret) when enabled
*/}}
{{- $secretName := include "ekh.credentialsSecretName" . -}}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName -}}

{{- $postgresPassword := "" -}}
{{- $rabbitmqPassword := "" -}}

{{- if $existingSecret -}}
  {{- $postgresPassword = index $existingSecret.data "postgres-password" | b64dec -}}
  {{- $rabbitmqPassword = index $existingSecret.data "rabbitmq-password" | b64dec -}}
{{- else -}}
  {{- $postgresPassword = randAlphaNum 32 -}}
  {{- $rabbitmqPassword = randAlphaNum 32 -}}
{{- end -}}

apiVersion: v1
kind: Secret
metadata:
  name: ekh-credentials
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ekh.labels" . | nindent 4 }}
type: Opaque
data:
  postgres-password: {{ $postgresPassword | b64enc | quote }}
  rabbitmq-password: {{ $rabbitmqPassword | b64enc | quote }}
